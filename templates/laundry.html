{% extends 'base.html' %}

{% block content %}
    <h1>{% block title %} 375 Lincoln Place Laundry Monitor {% endblock %}</h1>
	    
    <div id="4f" class="card">
        <div class="card-body">
            <h5 class="card-title">Fourth Floor</h5>
            <p id="t4" class="card-subtitle">sometime</p>
            <p class="card-text" id="dryer4" style="background-color:gray;">"?"</p>
            <p class="card-text" id="washer4" style="background-color:gray;">"?"</p>
        </div>
    </div>
    <div id="3f" class="card">
        <div class="card-body">
            <h5 class="card-title">Third Floor</h5>
            <p id="t3" class="card-subtitle">sometime</p>
            <p id="dryer3" style="background-color:gray;">"?"</p>
            <p id="washer3" style="background-color:gray;">"?"</p>
        </div>
    </div>
    <div id="2f" class="card">
        <div class="card-body">
            <h5 class="card-title">Second Floor</h5>
            <p id="t2" class="card-subtitle">sometime</p>
            <p id="dryer2" style="background-color:gray;">"?"</p>
            <p id="washer2" style="background-color:gray;">"?"</p>
        </div>
    </div>
    <div id="1f" class="card">
        <div class="card-body">
            <h5 class="card-title">Basement</h5>
            <p id="t1" class="card-subtitle">sometime</p>
            <p id="dryer1" style="background-color:gray;">"?"</p>
            <p id="washer1" style="background-color:gray;">"?"</p>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script>
        $(function() {
            AVAIL = {"yes": {"color": "green", "text": "Available" },
                    "no": {"color": "red", "text": "In Use"},
                    "?": {"color": "gray", "text": "No Data"}}

            function setMachine(machine,avail,date){
                $(machine).css("background-color",AVAIL[avail].color).text(AVAIL[avail].text)
            }
            
            function update() {
                $.getJSON($SCRIPT_ROOT + '/status-json', {}, function(data) {
                    for (floor in data) {
                        d = new Date(data[floor][1]+"Z")
                        
                        if (!(["none","wash","dry","both"].includes(data[floor][0]))){
                            setMachine("#washer"+floor,"?",d)
                            setMachine("#dryer"+floor,"?",d)
                            continue
                        }
                        if (Date.now()-d > 86400*1000) {
                            $("#t"+floor).text("Last Updated "+d.toLocaleDateString())
                            setMachine("#washer"+floor,"?",d)
                            setMachine("#dryer"+floor,"?",d)
                            continue
                        }
                        $("#t"+floor).text("Last Updated "+d.toLocaleTimeString())
                        w = ["wash","both"].includes(data[floor][0]) ? "no": "yes"
                        d = ["dry", "both"].includes(data[floor][0]) ? "no": "yes"
                        
                        setMachine("#washer"+floor,w,d)
                        setMachine("#dryer"+floor,d,d)
                    }                    
                })
            }
            update()
            setInterval(function() {
                update()
            }, 1000);
        });
    </script>
{% endblock %}
